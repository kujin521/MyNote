## 数据库访问类

因为几乎所有页面都涉及数据库的访问，所有我们把访问数据库的操作抽象为一个独立的公共类文件DB.cs。并把数据库连接字符串存放到web.config配置文件中。
在“解决方案资源管理器”窗口中，为项目添加ASP.NET文件夹App_Code，在App_Code目录中，添加一个C#类文件DB.cs。
该类中定义了以下方法成员：构造函数DB()，打开数据库连接的方法open()，关闭连接的方法close()，执行非查询SQL语句的方法ExecuteSQLNonQuery(string sql, List<SqlParameter> sqlParams, bool bTran = false)，获取DataTable对象的查询方法 GetDataTable(string sqlStr)，获取DataRow的查询方法GetDataRow(string sqlStr) 以及事务处理相关的几个方法。



## 数据实体类

在微博系统中的操作可分为两类：一类是针对用户的，一类是针对消息的。所以我们把用户和消息分别封装为不同的实体类，然后在类中实现相应的操作。

### 用户实体类

在App_Code目录中添加新的类文件Wuser.cs。在该类中添加操作W_USER表所需的成员变量。通常类成员变量定义为私有的，然后定义相应的属性来访问这些私有变量，本书为了使程序简化，直接将成员定义为自动属性。
除了对于W_USER表字段的自动属性之外，上述代码还定义了一个errorMsg属性，该属性的作用是，当对用户的操作失败或出现异常时，反馈错误信息给调用者。

### 用户相关操作

注册新用户，包括注册前的检查用户名和个人微博地址是否可用；
用户登录系统，登录成功后获取用户收听的用户数、用户的听众数、用户发表的消息数等信息；
个人信息维护； 
发表新消息；
收听和取消收听其他用户，包括检查是否已经收听某用户；
查找用户。

### 消息实体类

与消息相关的操作主要有如下几个： 
获取消息，包括获取所有用户的消息、获取指定用户的消息和获取登录用户及其收听用户的消息；
删除自己的消息；
转播或评论消息； 
获取某消息的所有转播或评论记录。

## 添加母版页

- 为了使网站的所有页面都具有相同的布局风格和外观，所以添加母版页，然后基于该母版页创建其他页面。
  新建母版页，名称为MasterPage.master。
- 在母版页中有两个ContentPlaceHolder控件，一个位于<head>标记中，一个位于<form>中。
- 删除<head>标记中的<title>标记，这样，在内容页中可以设置每个内容页的标题信息。

- 在母版页的后台代码中需要实现如下功能：
  - 加载页面时，根据用户当前是否登录显示或隐藏相应的Panel控件，
  - 实现用户的快速登录功能，登录成功后，将用户信息保存至Session变量中。	

- 在母版页的后台代码中需要实现如下功能：
  - 加载页面时，根据用户当前是否登录显示或隐藏相应的Panel控件，实现用户的快速登录功能，
  - 登录成功后，将用户信息保存至Session变量中。

## 首页Index.asp

- 由于该页需要多次后台交互，所以设计为异步刷新，在内容区域中首先添加ScriptManager和UpdatePanel控件。
- 后面添加的控件都放置在UpdatePanel控件内。
  该页面通过两个<div>来进行布局，一个id为left，一个id为right，左边的<div>包含一个Panel控件，用于显示登录用户的相关信息；
- 右边的<div>包含一个MultiView控件，该MultiView控件中包含2个View控件，其中View1包含2个Panel控件，
- 一个用于发表新消息，一个用于显示已发表的消息，View2用于显示用户的听众或用户收听的用户列表。
- 在“源”视图中，可以看到页面的代码层次结构如图12-2所示。

## 注册页面

注册页面Register.aspx比较简单，只需提供用户注册所需的表单即可。



## 个人信息维护页

个人信息维护页Modify.aspx用于修改个人信息，上传头像等功能。
该页设置为异步刷新，在内容区域中首先添加ScriptManager和UpdatePanel控件，

然后在UpdatePanel控件中添加一个<table>表单

## 传播和评论消息页面

转播和评论消息页面Reply.aspx将根据请求参数显示指定消息和对该消息的所有评论，

同时，上方提供文本框，用户可以输入转播评论进行再次转播。

## 找人页面

找人页面Search.aspx可以根据姓名和所在地进行模糊查询，查找自己感兴趣的用户，进而进行收听。
该页主要包括一个表格，表格的前两行是查询条件，第3行是一个ListView控件，用于显示查询结果。

## 个人信息页面

个人资料页面UserInfo.aspx与Index.aspx页面非常相似，

只是该页显示的不是当前登录用户的信息，

而是查询出来的某个普通用户的基本信息以及他所发表的消息。