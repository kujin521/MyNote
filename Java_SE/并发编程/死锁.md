# 死锁

## 先看一下这段代码

```java
package com.concurrthread;

/**
 * 类：死锁
 * 编写人：kujin
 * 创建时间：2020/9/26
 */
public class DeadLockDemo {
    private static String A="A";
    private static String B="B";

    public static void main(String[] args) {
        new DeadLockDemo().deadLock();
    }

    private void deadLock() {
        Thread thread = new Thread(() -> {
            synchronized (A){
                try {
                    Thread.currentThread().sleep(2000);
                } catch (InterruptedException e) {
                    e.printStackTrace();
                }
                synchronized (B){
                    System.out.println("1");
                }
            }
        });
        Thread thread1 = new Thread(() -> {
            synchronized (B) {
                System.out.println("thread--1 b");
                synchronized (A){
                    System.out.println("2");
                }
            }
        });
        thread.start();
        thread1.start();
    }
}
```

利用dump线程查看 得出以下信息

thread-1 等待 lock a 持有者是 thread-0

thread-0 等待 lock a 持有者 thread-1

,哎呦我去, lock a 到底在谁拿的???

形成死循环

```verilog
Found one Java-level deadlock:
=============================
"Thread-1":
  waiting to lock monitor 0x00007f3a8c004e28 (object 0x00000000f0c5bb88, a java.lang.String),
  which is held by "Thread-0"
"Thread-0":
  waiting to lock monitor 0x00007f3a8c0062c8 (object 0x00000000f0c5bbb8, a java.lang.String),
  which is held by "Thread-1"

Java stack information for the threads listed above:
===================================================
"Thread-1":
   at com.concurrthread.DeadLockDemo.lambda$deadLock$1(DeadLockDemo.java:33)
   - waiting to lock <0x00000000f0c5bb88> (a java.lang.String)
   - locked <0x00000000f0c5bbb8> (a java.lang.String)
   at com.concurrthread.DeadLockDemo$$Lambda$2/303563356.run(Unknown Source)
   at java.lang.Thread.run(Thread.java:748)
"Thread-0":
   at com.concurrthread.DeadLockDemo.lambda$deadLock$0(DeadLockDemo.java:25)
   - waiting to lock <0x00000000f0c5bbb8> (a java.lang.String)
   - locked <0x00000000f0c5bb88> (a java.lang.String)
   at com.concurrthread.DeadLockDemo$$Lambda$1/471910020.run(Unknown Source)
   at java.lang.Thread.run(Thread.java:748)

Found 1 deadlock.
```

## 避免死锁的几个常见方法

-  避免一个线程同时获取多个锁。

- 避免一个线程在锁内同时占用多个资源，尽量保证每个锁只占用一个资源。

- 尝试使用定时锁，使用lock.tryLock（timeout）来替代使用内部锁机制。

  参考文章: https://www.cnblogs.com/hezhiyao/p/7637974.html

-  对于数据库锁，加锁和解锁必须在一个数据库连接里，否则会出现解锁失败的情况。

